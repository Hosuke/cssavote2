<!DOCTYPE html>
<html ng-app="cssavote">
<head>
  <title></title>
  <script src="/js/angular.min.js" type="text/javascript"></script>
  <script src="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script>
</head>

<body>
  <div ng-controller="votingcode">
    <input type="string" id="votingcode" value="{{votingcode}}" />
    <button type="submit" ng-click="submit_votingcode()">Submit</button>
  </div>

  <div ng-controller="elections" style="display: one;" id="elections">
    <div ng-repeat="e in elections">
      <h1>{{ e.election }}</h1>
      <div ng-repeat="c in e.candidates">
        {{c.name}}
        <input type="text" ng-model="c.rank"></input>
      </div>
    </div>
    <button type="submit" ng-click="submit_votes()">Submit votes</button>
  </div>

  <script type="text/javascript">
    var app = angular.module("cssavote", []);

    function go_to_elections_view() {
      $("#elections").css("display","block");
    }

    app.controller("votingcode", ['$scope', '$http',
      function ($scope, $http) {
        $scope.votingcode = "fooo"

        $scope.submit_votingcode = function() {
          $http.post('/votingcode', {votingcode:$scope.votingcode})
          .success(function(data, status, headers, config) {
            token = data.token;  // global by nature
            go_to_elections_view();
          })
          .error(function(data, status, headers, config) {
            console.log("Invalid code");
          })
        }
    }]);

    app.controller("elections", ['$scope', '$http',
      function ($scope, $http) {
        $http.get('/elections').success(function(data, status, headers, config) {
          $scope.elections = data;
          elections = data;
        })

        $scope.submit_votes = function() {
          votes = [];
          for (election in $scope.elections) {
            var e = {};
            e.election = $scope.elections[election].election;
            e.votes = [];
            for (candidate in $scope.elections[election].candidates) {
              var v = {};
              v.id = $scope.elections[election].candidates[candidate].id;

              // ensure that each candidate has been voted on
              if (!$scope.elections[election].candidates[candidate].rank) {
                // should raise an error
                return;
              } else {
                v.rank = $scope.elections[election].candidates[candidate].rank;
              }
              e.votes.push(v);
            }

            console.log(e);
          }

          $http.post('/votes?token=' + token, e)
          .success(function(data, status, headers, config) {
            console.log("Done!");
          })
          .error(function(data, status, headers, config) {
            console.log("Invalid token");
          })
        }
    }]);

  </script>
</body>
</html>
